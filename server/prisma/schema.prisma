generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Church {
  id         Int              @id @default(autoincrement())
  name       String
  slug       String           @unique
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  users      UserChurchRole[]
  ministries Ministry[]
  events     Event[]

  @@map("churches")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  SECRETARY
  MINISTER
  DEPARTMENT_HEAD
}

model User {
  id          Int              @id @default(autoincrement())
  email       String           @unique
  name        String
  avatarUrl   String?
  googleId    String           @unique
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  churchRoles UserChurchRole[]

  @@map("users")
}

model UserChurchRole {
  id          Int              @id @default(autoincrement())
  userId      Int
  churchId    Int
  role        Role
  user        User             @relation(fields: [userId], references: [id])
  church      Church           @relation(fields: [churchId], references: [id])
  ministryId  Int?
  ministry    Ministry?        @relation(fields: [ministryId], references: [id])
  departments UserDepartment[]

  @@unique([userId, churchId, role])
  @@map("user_church_roles")
}

model UserDepartment {
  id               Int            @id @default(autoincrement())
  userChurchRoleId Int
  departmentId     Int
  userChurchRole   UserChurchRole @relation(fields: [userChurchRoleId], references: [id])
  department       Department     @relation(fields: [departmentId], references: [id])

  @@unique([userChurchRoleId, departmentId])
  @@map("user_departments")
}

model Ministry {
  id          Int              @id @default(autoincrement())
  name        String
  churchId    Int
  church      Church           @relation(fields: [churchId], references: [id])
  departments Department[]
  userRoles   UserChurchRole[]
  createdAt   DateTime         @default(now())

  @@map("ministries")
}

model Department {
  id         Int               @id @default(autoincrement())
  name       String
  ministryId Int
  ministry   Ministry          @relation(fields: [ministryId], references: [id])
  members    Member[]
  eventDepts EventDepartment[]
  userDepts  UserDepartment[]
  createdAt  DateTime          @default(now())

  @@map("departments")
}

model Member {
  id           Int        @id @default(autoincrement())
  firstName    String
  lastName     String
  departmentId Int
  department   Department @relation(fields: [departmentId], references: [id])
  plannings    Planning[]
  createdAt    DateTime   @default(now())

  @@map("members")
}

model Event {
  id         Int               @id @default(autoincrement())
  title      String
  type       String
  date       DateTime
  churchId   Int
  church     Church            @relation(fields: [churchId], references: [id])
  eventDepts EventDepartment[]
  createdAt  DateTime          @default(now())

  @@map("events")
}

model EventDepartment {
  id           Int        @id @default(autoincrement())
  eventId      Int
  departmentId Int
  event        Event      @relation(fields: [eventId], references: [id])
  department   Department @relation(fields: [departmentId], references: [id])
  plannings    Planning[]

  @@unique([eventId, departmentId])
  @@map("event_departments")
}

enum ServiceStatus {
  EN_SERVICE
  EN_SERVICE_DEBRIEF
  INDISPONIBLE
  REMPLACANT
}

model Planning {
  id                Int             @id @default(autoincrement())
  eventDepartmentId Int
  memberId          Int
  status            ServiceStatus?
  eventDepartment   EventDepartment @relation(fields: [eventDepartmentId], references: [id])
  member            Member          @relation(fields: [memberId], references: [id])
  updatedAt         DateTime        @updatedAt

  @@unique([eventDepartmentId, memberId])
  @@map("plannings")
}
